name: Build ADF

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      Environment:
        type: string
        description: Which Environment to deploy to (dev, test, prod)
        required: true
        default: dev

jobs:
  Build_ADF:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js environment
      uses: actions/setup-node@v3.4.1
      with:
        node-version: 14.x

    - name: Install ADF Utilities package
      run: npm install
      working-directory: ${{github.workspace}}/ADF/build

    - name: Validate ADF Pipelines
      run: |
        node --max_old_space_size=4096 ${{github.workspace}}/ADF/build/node_modules/@microsoft/azure-data-factory-utilities/lib/index validate ${{github.workspace}}/ADF/ /subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP_NAME }}/providers/Microsoft.DataFactory/factories/nuudw-adf01-${{ inputs.Environment }} >> ${{github.workspace}}/build-output.log 2>&1
      working-directory: ${{github.workspace}}/ADF/build

    - name: Validate and Generate ARM Template
      run: |
        node --max_old_space_size=4096 ${{github.workspace}}/ADF/build/node_modules/@microsoft/azure-data-factory-utilities/lib/index export ${{github.workspace}}/ADF/ /subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP_NAME }}/providers/Microsoft.DataFactory/factories/nuudw-adf01-${{ inputs.Environment }} "ExportedArmTemplate" >> ${{github.workspace}}/build-output.log 2>&1
      working-directory: ${{github.workspace}}/ADF/build

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ExportedArmTemplate
        path: ${{github.workspace}}/ADF/build/ExportedArmTemplate
